#!/bin/bash

set -xe

apt-get install -y python3-venv
_LANG="zh-TW"
CV="${SHARED_DIR}/data/mozilla/CommonVoice/v2.0-alpha2.0/${_LANG}"

# venv
apt-get install -y python3-venv
python3 -m venv /tmp/venv
source /tmp/venv/bin/activate
# check HTTP_PROXY
if ! (( $( env | grep -iq "^http_proxy=" ) )); then
    source /etc/profile
fi

pip install -r <(grep -v tensorflow requirements.txt)
pip install tensorflow-gpu==1.13.0-rc2
# Install ds_ctcdecoder package from TaskCluster
pip install $(python3 util/taskcluster.py --decoder)

# kenlm Dependencies
apt-get install -y build-essential cmake libboost-all-dev zlib1g-dev libbz2-dev liblzma-dev libeigen3-dev

# Install Kenlm #
# wget -O - https://kheafield.com/code/kenlm.tar.gz | tar xz --no-same-owner
# mkdir kenlm/build
# cd kenlm/build
# cmake ..
# make -j `nproc`
# cd ../..


###################################
### CREATE ALPHABET / LM / TRIE ###
###################################

# alphabet.txt
python util/check_characters.py \
        -csv "${CV}/cv_${_LANG}_valid_train.csv","${CV}/cv_${_LANG}_valid_train.csv","${CV}/cv_${_LANG}_valid_train.csv" \
        -alpha \
    > data/alphabet.txt

# lm.arpa
# TEXT="${SHARED_DIR}/data/wikipedia/zh-tw/wiki.txt"
# sed -e 's/\(.\)/\1 /g' <$TEXT >CHAR_GRAMS
/data/rw/home/kenlm/build/bin/lmplz \
    --order 2 \
    --text "/data/rw/home/CHAR_GRAMS_ZH_TW" \
    --arpa lm.arpa

# lm.binary
/data/rw/home/kenlm/build/bin/build_binary \
    -a 255 \
    -q 8 trie \
    lm.arpa \
    data/lm/lm.binary

# trie 
../tmp/native_client/generate_trie \
    data/alphabet.txt \
    data/lm/lm.binary \
    data/lm/trie_utf8

rm lm.arpa


########################
### TRAIN DEEPSPEECH ###
########################

mkdir -p ../keep/summaries

python -u DeepSpeech.py \
  --train_files "${CV}/cv_${_LANG}_valid_train.csv" \
  --dev_files "${CV}/cv_${_LANG}_valid_dev.csv" \
  --test_files "${CV}/cv_${_LANG}_valid_test.csv" \
  --train_batch_size 24 \
  --dev_batch_size 48 \
  --test_batch_size 48 \
  --noearly_stop \
  --n_hidden 2048 \
  --learning_rate 0.0001 \
  --dropout_rate 0.2 \
  --epoch 30 \
  --display_step 0 \
  --validation_step 1 \
  --checkpoint_dir "../keep" \
  --summary_dir "../keep/summaries"
