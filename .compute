#!/bin/bash

pip3 install -r <(grep -v tensorflow requirements.txt)
pip3 install tensorflow-gpu==1.12.0

python3 util/taskcluster.py --arch gpu --target ../tmp/native_client

# Install ds_ctcdecoder package from TaskCluster
# pip install $(python3 util/taskcluster.py --decoder)

pushd native_client/ctcdecode
make clean
make NUM_PROCESSES=16
pip3 install dist/*.whl
popd

mkdir -p ../keep/summaries

LANG="sl"
cv="$SHARED_DIR/data/mozilla/CommonVoice/v2.0-alpha2.0/$LANG"

python3 -u DeepSpeech.py \
  --train_files '$CV/cv_${LANG}_valid_train.csv' \
  --dev_files '$CV/cv_${LANG}_valid_dev.csv' \
  --test_files '$CV/cv_${LANG}_valid_test.csv' \
  --train_batch_size 24 \
  --dev_batch_size 48 \
  --test_batch_size 48 \
  --noearly_stop \
  --n_hidden 2048 \
  --learning_rate 0.0001 \
  --dropout_rate 0.15 \
  --epoch 1 \
  --display_step 0 \
  --validation_step 1 \
  --checkpoint_dir "../keep" \
  --summary_dir "../keep/summaries"
