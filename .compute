#!/bin/bash

source ../tmp/venv/bin/activate

sets="${DATA_ROOT}/groups/ds/sets/"

training_phase() {
  python3 -u DeepSpeech.py \
    --train_batch_size 24 \
    --dev_batch_size 48 \
    --test_batch_size 48 \
    --notest \
    --n_hidden 2048 \
    --learning_rate 0.0001 \
    --noearly_stop \
    --display_step 0 \
    --validation_step 1 \
    --noshow_progressbar \
    --coord_port=${GROUP0_PROCESS0_PORT0:=0} \
    --decoder_library_path "../tmp/native_client/libctc_decoder_with_kenlm.so" \
    "$@"
}

echo "Moving best_checkpoint of continued training to next phase..."
mv ../keep ../tmp/keep
mkdir -p ../keep/phase2
mv ../tmp/keep/best_validation* ../keep/phase2/
rm -rf ../tmp/keep
echo 'model_checkpoint_path: "best_validation"' >>../keep/phase2/checkpoint
echo 'all_model_checkpoint_paths: "best_validation"' >>../keep/phase2/checkpoint

echo "Starting training-phase 2 (low noise)..."
training_phase \
    --checkpoint_dir "../keep/phase2" \
    --summary_dir "../keep/summaries/phase2" \
    --train_cached_features_path "${sets}/ds_train_noise1.hdf5" \
    --dev_cached_features_path   "${sets}/ds_dev_noise1.hdf5" \
    --test_cached_features_path  "${sets}/ds_test.hdf5" \
    --dropout_rate 0.2 \
    --epoch 60


echo "Moving best_checkpoint of phase 2 to next phase..."
rm -rf ../keep/phase3
mkdir ../keep/phase3
mv ../keep/phase2/best_validation* ../keep/phase3/
echo 'model_checkpoint_path: "best_validation"' >>../keep/phase3/checkpoint
echo 'all_model_checkpoint_paths: "best_validation"' >>../keep/phase3/checkpoint

echo "Starting training-phase 3 (high noise)..."
training_phase \
    --checkpoint_dir "../keep/phase3" \
    --summary_dir "../keep/summaries/phase3" \
    --train_cached_features_path "${sets}/ds_train_noise2.hdf5" \
    --dev_cached_features_path   "${sets}/ds_dev_noise2.hdf5" \
    --test_cached_features_path  "${sets}/ds_test.hdf5" \
    --dropout_rate 0.2 \
    --epoch 120
