#!/bin/bash

set -xe
# check HTTP_PROXY
if ! (( $( env | grep -iq "^http_proxy=" ) )); then
    source /etc/profile
fi

# venv
apt-get update -y
apt-get install -y python3-venv
python3 -m venv /tmp/venv
source /tmp/venv/bin/activate

pip install -r <(grep -v tensorflow requirements.txt)
pip install tensorflow-gpu==1.13.0-rc2
pip install $(python util/taskcluster.py --decoder)
python util/taskcluster.py --target ../tmp/native_client


########################
### TRAIN DEEPSPEECH ###
########################

# python util/check_characters.py \
#        -csv "/data/rw/home/ky/clips/train.csv","/data/rw/home/ky/clips/test.csv","/data/rw/home/ky/clips/dev.csv" \
#        -alpha \
#        > /data/rw/home/ky/alphabet.txt

# ../tmp/native_client/generate_trie \
#     /data/rw/home/ky/alphabet.txt \
#     /data/rw/home/ky/lm.binary \
#     /data/rw/home/ky/trie

mkdir -p ../keep/summaries
  
python -u DeepSpeech.py \
  --train_files "/data/rw/home/ky/clips/train.csv" \
  --dev_files "/data/rw/home/ky/clips/dev.csv" \
  --test_files "/data/rw/home/ky/clips/test.csv" \
  --train_batch_size 24 \
  --dev_batch_size 48 \
  --test_batch_size 48 \
  --n_hidden 2048 \
  --learning_rate 0.0001 \
  --dropout_rate 0.2 \
  --epoch 1000 \
  --earlystop_nsteps 5 \
  --display_step 0 \
  --validation_step 1 \
  --checkpoint_dir "../keep" \
  --summary_dir "../keep/summaries" \
  --report_count 100 \
  --test_output_file "../keep/RESULTS.json" \
  --lm-binary-path "/data/rw/home/ky/lm.binary" \
  --lm-trie-path "/data/rw/home/ky/trie" \
  --alphabet-config-path "/data/rw/home/ky/alphabet.txt"
